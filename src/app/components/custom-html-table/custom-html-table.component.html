<div class="flex flex-col w-fit">
  <table>
    <thead>
      <tr>
        <th colspan="2"></th>
        <th [colSpan]="columnData.length" class="bg-green-600">
          {{ "options" | titlecase }}
        </th>
      </tr>
      <tr
        cdkDropList
        cdkDropListOrientation="horizontal"
        (cdkDropListDropped)="columnDropMethod($event)"
      >
        <th>{{ "criteria" | titlecase }}</th>
        <th>{{ "weight" | titlecase }}</th>
        <ng-container
          *ngFor="
            let column of columnData;
            let colIdx = index;
            trackBy: trackByFn
          "
        >
          <th
            [ngClass]="
              highlightedTableElementIdx.tableElement ===
                tableOperationConstants.columnHeader &&
              highlightedTableElementIdx.idx[0] === colIdx
                ? 'highlight'
                : null
            "
            *ngIf="
              !(
                modifiedTableElementIdx.tableElement ===
                  tableOperationConstants.columnHeader &&
                modifiedTableElementIdx.idx[0] === colIdx
              );
              else headerRenameInputTemplate
            "
            class="draggable-cell"
            cdkDrag
            (mousedown)="$event.stopPropagation()"
            cdkDragLockAxis="x"
            (dblclick)="
              modifyTableElement(tableOperationConstants.columnHeader, [colIdx])
            "
          >
            {{ column.columnName | titlecase }}
          </th>
        </ng-container>
        <button
          class="opacity-40 hover:opacity-100"
          mat-icon-button
          color="primary"
          (click)="addCandidate()"
        >
          <mat-icon>add</mat-icon>
        </button>
      </tr>
    </thead>
    <tbody cdkDropList (cdkDropListDropped)="rowDropMethod($event)">
      <tr
        cdkDrag
        *ngFor="let row of tableData; let weightIndex = index"
        class="table-row"
      >
        <!-- implement table header modification for row headers -->
        <th
          class="text-left"
          *ngIf="
            !(
              modifiedTableElementIdx.tableElement ===
                tableOperationConstants.rowHeader &&
              modifiedTableElementIdx.idx[0] === weightIndex
            );
            else headerRenameInputTemplate
          "
          (dblclick)="
            modifyTableElement(tableOperationConstants.rowHeader, [weightIndex])
          "
        >
          {{ row.fieldName }}
        </th>
        <td
          [ngClass]="
            highlightedTableElementIdx.tableElement ===
              tableOperationConstants.fieldWeight &&
            highlightedTableElementIdx.idx[0] === weightIndex
              ? 'highlight'
              : null
          "
          *ngIf="
            !(
              modifiedTableElementIdx.tableElement ===
                tableOperationConstants.fieldWeight &&
              modifiedTableElementIdx.idx[0] === weightIndex
            );
            else tableDataUpdateInputTemplate
          "
          (dblclick)="
            modifyTableElement(tableOperationConstants.fieldWeight, [
              weightIndex
            ])
          "
          class="text-center text-blue-600"
        >
          {{ row.fieldWeight }}
        </td>
        <ng-container
          *ngFor="
            let item of row.fieldValues;
            let cellIdx = index;
            trackBy: trackByFn
          "
        >
          <td
            [class.highlight]="
              highlightedTableElementIdx.idx[0] === weightIndex &&
              highlightedTableElementIdx.idx[1] === cellIdx
            "
            *ngIf="
              !(
                modifiedTableElementIdx.tableElement ===
                  tableOperationConstants.cell &&
                (modifiedTableElementIdx.idx
                  | assertArrayEquality : [weightIndex, cellIdx])
              );
              else tableDataUpdateInputTemplate
            "
            class="text-blue-600 text-center w-20"
            (click)="
              highlightTableElement(tableOperationConstants.cell, [
                weightIndex,
                cellIdx
              ])
            "
            (dblclick)="
              modifyTableElement(tableOperationConstants.cell, [
                weightIndex,
                cellIdx
              ])
            "
          >
            {{ item }}
          </td>
        </ng-container>
      </tr>

      <tr *ngIf="displayResults">
        <th colspan="2">{{ "results" | titlecase }}</th>
        <td class="text-center text-blue-600" *ngFor="let column of columnData">
          {{ column.result }}
        </td>
      </tr>
      <tr>
        <th class="add-criterion" [colSpan]="columnData.length + 2">
          <div class="button-container">
            <button
              (click)="addRow()"
              mat-flat-button
              color="primary"
              class="opacity-40 hover:opacity-100"
            >
              <mat-icon>add</mat-icon>
              {{ "add criterion" | titlecase }}
            </button>
            <button
              class="ml-4 opacity-50 hover:opacity-100"
              mat-mini-fab
              color="primary"
              (click)="calculateResult()"
            >
              <mat-icon>calculate</mat-icon>
            </button>
          </div>
        </th>
      </tr>
    </tbody>
    <tfoot></tfoot>
  </table>
</div>

<ng-template #headerRenameInputTemplate>
  <th>
    <input
      #headerRenamingInputComponent
      matInput
      placeholder="option name..."
      (keydown.enter)="submitForm()"
      (focusout)="inputFocusOutHandler()"
      [formControl]="headerRenamingFormControl"
      label="header-rename"
      type="text"
    />
  </th>
</ng-template>
<ng-template #tableDataUpdateInputTemplate>
  <th>
    <input
      #tableDataUpdateInputComponent
      matInput
      placeholder="update data..."
      (keydown.enter)="submitForm()"
      (focusout)="inputFocusOutHandler()"
      [formControl]="tableDataUpdateFormControl"
      label="header-rename"
      type="number"
    />
    <div class="text-red-500" *ngIf="tableDataUpdateFormControl.invalid">
      please enter a value between 1 to 10
    </div>
  </th>
</ng-template>
